---
# this is a playbook to install agent on new instances in AWS.
# the inventory group is generated by Tower based on an absent tag which is populated at the end of this playbook.
# 

- name: query for NGINX Controller information
  hosts: localhost
  gather_facts: false
  connection: local

  tasks:
    - include_role:
        name: ansible-role-nginx-controller-generate-token

    - name: Get controller api key for agent registration
      uri:
        url: "https://{{controller_fqdn}}/api/v1/platform/global"
        method: "GET"
        return_content: yes
        status_code: 200
        validate_certs: false
        headers:
          Cookie: "{{controller_auth_token}}"
      register: ctrl_globals

    - name: Copy api_key to a variable
      set_fact:
        api_key: "{{ctrl_globals.json.currentStatus.agentSettings.apiKey}}"


- name: install nginx controller agent
  hosts: noagent
  gather_facts: true

  vars:
    controller_hostname: "{{ inventory_hostname }}"
  tasks:
  - debug:
    - msg: upgrade software on {{inventory_hostname}}
    - msg: current host is {{ansible_hostname}}
    - msg: controller_hostname is {{controller_hostname}}

  # - name: install minimal support for python2 for Agent install script
  #   apt:
  #     name: "{{ packages }}"
  #     state: present
  #   vars:
  #     packages:
  #     - python-minimal
  #     - libxerces-c3.2

  # - name: install the NGINX Controller agent on new instances
  #   include_role:
  #     name: ansible-role-nginx-controller-agent
  #   vars:
  #     controller_hostname: "{{hostname}}"
  #   loop:
  #     controller_hostname
  #   loop_control:
  #     loop_var: hostname

  # - name: set the contorller_hostname tag 